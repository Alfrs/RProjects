---
title: "Lab1"
output: word_document
---

# LABORATORIO 1

## Importando librerias

```{r}

library(dplyr)
library(ggplot2)
library(plotly)
library(caret)
library(lattice)
library(doSNOW)
library(tidyr)

```

## Cargando datos

```{r}

setwd("D:/alfrs/Documents/git/RProjects/Lab 1")
train_set <- read.csv("train.csv")
test_set <- read.csv("test.csv")

head(train_set)
head(test_set)

```

## Revisando estructuras de datos

```{r}

str(dataset)

```

## Limpia de datos

```{r}

dataset <- train_set
dataset$age_factor <- cut(round(dataset$Age,digits=0),breaks=8)

# dataset$age_factor[is.na(dataset$age_factor)]<-"NA"
dataset$age_factor <- as.character(dataset$age_factor)
dataset$age_factor <- replace_na(dataset$age_factor,replace = "Other")
dataset$age_factor <- as.factor(dataset$age_factor)
dataset$Survived <- as.factor(dataset$Survived)

```


## Tiene algo que ver el genero con el hecho de que el pasajero sobrevivio?
## Hipotesis: Las mujeres tenian prioridad sobre los hombres a la hora de evacuar el barco?

```{r}

gender_graph <- 
ggplot(dataset %>%
  count(Sex,Survived),aes(x = Sex, y = n,fill=Survived))+
  geom_col()+
  geom_text(aes(label = n),position = position_stack(vjust = .5)) +
  ggtitle("Count of Passengers by Gender")+
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
  ylab("Count of passengers") +
  coord_flip()

ggplotly(gender_graph)

```

### Si, las mujeres sobrevivieron mas que los hombres

## Tiene algo que ver el la edad del pasajero con el hecho de sobrevivir?
## Hipotesis: Mujeres y ni?os primero, los pasajeros menores de 18 a?os tendran mayor probabilidad de sobrevivir

```{r}

age_group_graph <- 
ggplot(dataset %>%
  count(age_factor,Survived),aes(x = age_factor, y = n,fill=Survived))+
  geom_col()+
  geom_text(aes(label = n),position = position_stack(vjust = .5)) +
  ggtitle("Count of Passengers by Age Group")+
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
  ylab("Count of passengers") +
  coord_flip()

ggplotly(age_group_graph)

```

### Aparentemente la regla no se cumple, solamente se salvaron 82 pasajeros entre las edades de 0 a 20 a?os
### Esto en contra de, por ejemplo, pasajeros entre 20 y 30 a?os de edad, donde se salvaron 84 personas


# Modelo ML

```{r}

dataset_fil <- dataset %>%
  select(Survived,Sex,Age,Pclass,Embarked,SibSp,Parch)

dataset_fil$Age <- replace_na(dataset_fil$Age,quantile(na.exclude(dataset$Age),probs=0.5))

set.seed(1993)

indexes<-createDataPartition(dataset_fil$Survived,
                             times = 1,
                             p=0.7, 
                             list = FALSE)

trainingset<-dataset_fil[indexes,]

testset<-dataset_fil[-indexes,]

prop.table(table(trainingset$Survived))
prop.table(table(testset$Survived))

```


## Crear folds para validacion cruzada

```{r}

cv.folds<-createMultiFolds(trainingset$Survived, k=5, times = 1)

cv.cntrl<-trainControl(method = "repeatedcv", number = 5, repeats = 1, index = cv.folds)

```

# Configurar parametros de busqueda

```{r}

grid_rf<-expand.grid(mtry=c(4,6), splitrule=c("gini","extratrees"), min.node.size=1)

gridxgb<-expand.grid(nrounds=c(100,200), max_depth=c(1,3),
                     eta=c(0.1,0.4),gamma=c(0,3),
                     colsample_bytree=c(0.7,0.9),
                     min_child_weight=1, subsample=1)


```

# correr el algoritmo

```{r}
#require(doSNOW)
#require(e1071)
#require(ranger)

#Sys.time()
start.time<-Sys.time()

#cl<-makeCluster(4, type = "SOCK")
#registerDoSNOW(cl)

rf_primero<-train(Survived~., data=trainingset, method="ranger",
                  trControl=cv.cntrl, tuneLength=20,
                  importance="permutation")

total.time<-Sys.time()-start.time

total.time

rf_primero
plot(varImp(rf_primero))
#stopCluster(cl)
```

